<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Punto Aprobados - EII PUCV</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'sans-serif'] },
          colors: {
            brand: { light: '#4da6ff', DEFAULT: '#004481', dark: '#002a50' } // Azul m√°s institucional
          }
        },
      },
    }
  </script>
  
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
    .modal-overlay { display: none; position: fixed; z-index: 50; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center; backdrop-filter: blur(3px); }
    .modal-overlay.flex { display: flex; }
    .card-hover:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
    
    /* Spinner */
    .spinner { border: 4px solid #e2e8f0; border-top: 4px solid #004481; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>

  <script>
    window.showPage = function(pageId) {
      ['page-home', 'page-upload', 'page-subject'].forEach(page => {
        const el = document.getElementById(page);
        if (el) el.classList.toggle('hidden', page !== pageId);
      });
      window.scrollTo(0, 0);
    };
  </script>
</head>
<body class="text-slate-800">

  <!-- MODALES -->
  <div id="loading-modal" class="modal-overlay">
    <div class="bg-white p-6 rounded-2xl shadow-2xl text-center max-w-sm w-full mx-4">
      <div class="spinner mb-4"></div>
      <p id="loading-message" class="text-slate-600 font-medium">Procesando...</p>
    </div>
  </div>
  
  <div id="message-modal" class="modal-overlay">
    <div class="bg-white p-8 rounded-2xl shadow-2xl text-center max-w-md w-full mx-4">
      <h3 id="message-title" class="text-xl font-bold mb-2 text-slate-900"></h3>
      <p id="message-body" class="mb-6 text-slate-600"></p>
      <button id="message-close-btn" class="bg-brand text-white px-6 py-2 rounded-lg hover:bg-brand-dark transition w-full font-medium">Entendido</button>
    </div>
  </div>

  <div class="container mx-auto max-w-6xl p-4 min-h-screen flex flex-col">
    
    <!-- HEADER -->
    <header class="bg-white shadow-sm rounded-2xl p-6 mb-8 border-t-4 border-brand flex flex-col md:flex-row justify-between items-center gap-6">
      <div class="text-center md:text-left">
        <h1 class="text-3xl font-extrabold text-brand tracking-tight">Punto Aprobados</h1>
        <p class="text-slate-500 text-sm font-medium">Repositorio EII PUCV - Gesti√≥n del Conocimiento</p>
      </div>
      <nav class="flex gap-3">
        <button onclick="window.showPage('page-home')" class="px-5 py-2.5 rounded-xl font-semibold text-brand bg-blue-50 hover:bg-blue-100 transition">üìö Biblioteca</button>
        <button onclick="window.showPage('page-upload')" class="px-5 py-2.5 rounded-xl font-semibold text-white bg-brand hover:bg-brand-dark shadow-md transition flex items-center gap-2"><span>üì§</span> Subir</button>
      </nav>
    </header>

    <main id="app-container" class="flex-grow">
      
      <!-- HOME -->
      <div id="page-home">
        <div class="bg-gradient-to-r from-brand to-blue-600 rounded-3xl p-8 mb-8 text-white shadow-lg">
          <h2 class="text-2xl font-bold mb-2">Encuentra tu material</h2>
          <p class="mb-6 opacity-90">Busca por asignatura, profesor o autor del apunte.</p>
          <input type="text" id="search-bar" placeholder="üîé Escribe aqu√≠ (ej: C√°lculo, Wilson, Juan P√©rez)..." class="w-full p-4 rounded-xl text-slate-800 focus:ring-4 focus:ring-blue-300 outline-none shadow-inner">
        </div>

        <div id="subjects-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
          <div class="col-span-full text-center py-10 text-slate-500">
            <div class="spinner mb-2"></div>Cargando repositorio...
          </div>
        </div>
      </div>

      <!-- SUBIR MATERIAL -->
      <div id="page-upload" class="hidden">
        <button onclick="window.showPage('page-home')" class="mb-4 text-slate-500 hover:text-brand font-medium flex items-center gap-1">‚Üê Volver</button>
        
        <div class="bg-white p-8 rounded-3xl shadow-xl max-w-2xl mx-auto border border-slate-100">
          <div class="border-b pb-4 mb-6">
            <h2 class="text-2xl font-bold text-slate-800">Subir Aporte</h2>
            <p class="text-slate-500 text-sm">Ayuda a las futuras generaciones compartiendo tu material.</p>
          </div>
          
          <form id="upload-form" class="space-y-5">
            <!-- Asignatura con Datalist de la Malla -->
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-1">Asignatura</label>
              <input list="subjects-options" name="subject" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:border-brand focus:ring-1 focus:ring-brand outline-none" placeholder="Selecciona o escribe..." required>
              <datalist id="subjects-options">
                <!-- A√±o 1 -->
                <option value="√Ålgebra Lineal">
                <option value="F√≠sica Mec√°nica 1">
                <option value="Fundamentos de Matem√°ticas">
                <option value="Introducci√≥n al Modelamiento Discreto">
                <option value="Fundamentos de Ingenier√≠a Industrial">
                <option value="Fundamentos de Qu√≠mica">
                <option value="Mundo Contempor√°neo">
                <option value="C√°lculo 1">
                <option value="Introducci√≥n a las Tecnolog√≠as de la Informaci√≥n">
                <option value="Taller de Creatividad e Innovaci√≥n">
                <!-- A√±o 2 -->
                <option value="F√≠sica Mec√°nica 2">
                <option value="C√°lculo 2">
                <option value="Arquitectura de Sistemas de Software">
                <option value="Termodin√°mica">
                <option value="F√≠sica Electromagnetismo">
                <option value="C√°lculo 3">
                <option value="Operaciones Unitarias">
                <option value="Ecuaciones Diferenciales">
                <!-- A√±o 3 -->
                <option value="Electrotecnia">
                <option value="An√°lisis Econ√≥mico 1">
                <option value="Fundamentos de Modelos Probabil√≠sticos">
                <option value="Inferencia Estad√≠stica">
                <option value="Taller de Comunicaci√≥n y Negociaci√≥n">
                <option value="Optimizaci√≥n Lineal">
                <option value="Electr√≥nica Industrial">
                <option value="An√°lisis Econ√≥mico 2">
                <option value="Teor√≠a de Sistemas">
                <option value="Teor√≠a de la Organizaci√≥n">
                <option value="Taller de Sistemas Productivos">
                <!-- A√±o 4 -->
                <option value="Investigaci√≥n de Operaciones">
                <option value="Gesti√≥n Contable y Presupuestaria">
                <option value="Gesti√≥n de Informaci√≥n">
                <option value="√âtica en Ingenier√≠a">
                <option value="Gesti√≥n Comercial">
                <option value="Evaluaci√≥n de Proyectos">
                <option value="Simulaci√≥n">
                <option value="Taller de Liderazgo y Trabajo en Equipo">
                <!-- A√±o 5 y 6 -->
                <option value="Planificaci√≥n de Operaciones">
                <option value="Ingenier√≠a Financiera">
                <option value="Modelamiento de Procesos y Sistemas">
                <option value="Log√≠stica Integral">
                <option value="Gesti√≥n de Servicios">
                <option value="Derecho Empresarial y Ambiental">
                <option value="Proyecto de Ingenier√≠a Industrial">
                <option value="Taller de Emprendimiento">
              </datalist>
            </div>

            <div>
              <label class="block text-sm font-bold text-slate-700 mb-1">Profesor(a)</label>
              <input type="text" name="professor" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:border-brand outline-none" placeholder="Ej: Pamela Wilson" required>
            </div>

            <!-- NUEVO CAMPO AUTOR -->
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-1">Autor del Apunte <span class="font-normal text-slate-400 text-xs">(Tu nombre)</span></label>
              <input type="text" name="author" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:border-brand outline-none" placeholder="Ej: Juan P√©rez (Opcional)">
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-bold text-slate-700 mb-1">Tipo</label>
                <select name="type" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:border-brand outline-none" required>
                  <option value="Apunte">üìù Apunte</option>
                  <option value="Guia">üìÑ Gu√≠a</option>
                  <option value="Examen">üéì Examen</option>
                  <option value="Control">‚è±Ô∏è Control</option>
                  <option value="Resumen">üìå Resumen</option>
                  <option value="Libro">üìö Libro</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-bold text-slate-700 mb-1">Archivo</label>
                <input type="file" name="file" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-brand hover:file:bg-blue-100" required>
              </div>
            </div>

            <button type="submit" class="w-full bg-brand text-white py-3.5 rounded-xl font-bold shadow-lg hover:shadow-xl hover:bg-brand-dark transform hover:-translate-y-0.5 transition-all">Subir Material üöÄ</button>
          </form>
        </div>
      </div>

      <!-- VISTA ASIGNATURA -->
      <div id="page-subject" class="hidden">
        <button onclick="window.showPage('page-home')" class="mb-6 text-slate-500 hover:text-brand font-medium flex items-center gap-1">‚Üê Volver a Asignaturas</button>
        
        <div class="bg-brand rounded-3xl p-8 mb-8 text-white shadow-lg relative overflow-hidden">
          <h2 id="subject-title" class="text-3xl font-bold relative z-10"></h2>
          <p class="text-blue-100 relative z-10 mt-1">Material disponible para descarga inmediata</p>
          <div class="absolute top-0 right-0 -mt-8 -mr-8 w-32 h-32 bg-white opacity-10 rounded-full"></div>
        </div>

        <div id="subject-files-list" class="space-y-3"></div>
      </div>

    </main>
    
    <footer class="mt-12 py-6 text-center text-slate-400 text-sm border-t border-slate-200">
      <p>Punto Aprobados ¬© 2025 ‚Ä¢ Ingenier√≠a Civil Industrial PUCV</p>
    </footer>
  </div>

  <!-- FIREBASE -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, serverTimestamp, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    // ==========================================
    // PASO 1: PEGA TUS LLAVES DE FIREBASE AQU√ç
    // ==========================================
const firebaseConfig = {
  apiKey: "AIzaSyBaItXWTtatnIXt0MSnnWvq3nVAscjdPP8",
  authDomain: "punto-aprobados.firebaseapp.com",
  projectId: "punto-aprobados",
  storageBucket: "punto-aprobados.firebasestorage.app",
  messagingSenderId: "856568268041",
  appId: "1:856568268041:web:43f3b44981445157bc3fd8",
  measurementId: "G-R9359F4FNX"
};
    // ==========================================

    let app, auth, db, storage, userId;
    let allMaterials = [];

    try {
      app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getFirestore(app);
      storage = getStorage(app);
    } catch(e) { console.error("Error init:", e); }

    // UI Helpers
    const loadingModal = document.getElementById('loading-modal');
    const msgModal = document.getElementById('message-modal');
    const showLoading = (msg) => { document.getElementById('loading-message').textContent = msg; loadingModal.classList.add('flex'); };
    const hideLoading = () => loadingModal.classList.remove('flex');
    const showMsg = (title, body) => {
      document.getElementById('message-title').textContent = title;
      document.getElementById('message-body').textContent = body;
      msgModal.classList.add('flex');
    };
    document.getElementById('message-close-btn').onclick = () => msgModal.classList.remove('flex');

    // CORE LOGIC
    function listenData() {
      onSnapshot(query(collection(db, "materiales_app")), (snapshot) => {
        allMaterials = [];
        snapshot.forEach(doc => allMaterials.push({id: doc.id, ...doc.data()}));
        renderHome(document.getElementById('search-bar').value);
        hideLoading();
      });
    }

    function renderHome(filter = '') {
      const list = document.getElementById('subjects-list');
      const map = new Map();
      const cleanFilter = filter.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");

      allMaterials.forEach(m => {
        const subj = m.subject || 'Otros';
        // B√∫squeda inteligente: incluye autor y profesor
        const meta = `${subj} ${m.professor} ${m.author || ''}`.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        
        if (filter && !meta.includes(cleanFilter)) return;

        if (!map.has(subj)) map.set(subj, { count: 0, profs: new Set() });
        const entry = map.get(subj);
        entry.count++;
        if (m.professor) entry.profs.add(m.professor);
      });

      list.innerHTML = '';
      if (map.size === 0) {
        list.innerHTML = `<div class="col-span-full text-center py-10 text-slate-400">No se encontraron resultados.</div>`;
        return;
      }

      [...map.entries()].sort().forEach(([subj, data]) => {
        const card = document.createElement('div');
        card.className = 'bg-white p-6 rounded-2xl shadow-sm border border-slate-100 cursor-pointer card-hover group';
        card.innerHTML = `
          <div class="flex justify-between items-start mb-3">
            <div class="p-3 bg-blue-50 rounded-xl text-brand text-xl">üìö</div>
            <span class="bg-slate-100 text-slate-600 text-xs font-bold px-2 py-1 rounded-lg">${data.count} Docs</span>
          </div>
          <h3 class="font-bold text-slate-800 text-lg group-hover:text-brand transition">${subj}</h3>
          <p class="text-sm text-slate-500 mt-2 truncate">Prof: ${[...data.profs].join(', ') || 'Varios'}</p>
        `;
        card.onclick = () => showSubjectPage(subj);
        list.appendChild(card);
      });
    }

    function showSubjectPage(subj) {
      window.showPage('page-subject');
      document.getElementById('subject-title').textContent = subj;
      const list = document.getElementById('subject-files-list');
      list.innerHTML = '';

      const files = allMaterials.filter(m => m.subject === subj);
      
      files.forEach(f => {
        const row = document.createElement('div');
        row.className = 'bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4';
        
        let icon = 'üìÑ';
        if(f.type === 'Examen') icon = 'üéì';
        if(f.type === 'Control') icon = '‚è±Ô∏è';

        row.innerHTML = `
          <div class="flex-grow w-full md:w-auto">
            <div class="flex items-center gap-3">
              <span class="text-2xl">${icon}</span>
              <div>
                <h4 class="font-bold text-slate-800">${f.fileName}</h4>
                <div class="flex flex-wrap gap-3 text-xs text-slate-500 mt-1">
                  <span class="bg-slate-100 px-2 py-0.5 rounded">üè∑Ô∏è ${f.type}</span>
                  <span>üë®‚Äçüè´ ${f.professor}</span>
                  <span class="text-brand font-medium">üë§ Por: ${f.author || 'An√≥nimo'}</span>
                </div>
              </div>
            </div>
          </div>
          <a href="${f.downloadURL}" target="_blank" class="w-full md:w-auto text-center bg-white border-2 border-brand text-brand hover:bg-brand hover:text-white px-6 py-2 rounded-lg font-bold transition">Descargar</a>
        `;
        list.appendChild(row);
      });
    }

    async function handleUpload(e) {
      e.preventDefault();
      const f = e.target;
      const file = f.file.files[0];
      
      if (!file) return showMsg("Error", "Falta el archivo");

      showLoading("Subiendo...");
      try {
        const docRef = await addDoc(collection(db, "materiales_app"), {
          subject: f.subject.value.trim(),
          professor: f.professor.value.trim(),
          author: f.author.value.trim() || 'An√≥nimo', // Guardamos el autor
          type: f.type.value,
          fileName: file.name,
          uploadedBy: userId,
          createdAt: serverTimestamp(),
          downloadURL: ''
        });

        const upTask = uploadBytesResumable(ref(storage, `materiales_app/${docRef.id}/${file.name}`), file);
        
        upTask.on('state_changed', null, 
          (err) => { console.error(err); hideLoading(); showMsg("Error", "Fall√≥ la subida"); },
          async () => {
            const url = await getDownloadURL(upTask.snapshot.ref);
            await updateDoc(docRef, { downloadURL: url });
            hideLoading();
            showMsg("¬°√âxito!", "Material publicado correctamente.");
            f.reset();
            window.showPage('page-home');
          }
        );
      } catch (err) { console.error(err); hideLoading(); showMsg("Error", "Ocurri√≥ un error."); }
    }

    // Init
    document.getElementById('upload-form').onsubmit = handleUpload;
    document.getElementById('search-bar').onkeyup = (e) => renderHome(e.target.value);
    
    window.addEventListener('DOMContentLoaded', () => {
      showLoading("Iniciando...");
      onAuthStateChanged(auth, (u) => {
        if (u) { userId = u.uid; listenData(); }
        else signInAnonymously(auth).catch(e => console.error(e));
      });
    });
  </script>
</body>
</html>

