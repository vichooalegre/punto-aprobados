<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Punto Aprobados - EII PUCV</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'sans-serif'] },
          colors: {
            brand: { light: '#4da6ff', DEFAULT: '#004481', dark: '#002a50' },
            gold: '#fbbf24'
          }
        },
      },
    }
  </script>
  
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
    .modal-overlay { display: none; position: fixed; z-index: 50; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center; backdrop-filter: blur(3px); }
    .modal-overlay.flex { display: flex; }
    .card-hover:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
    .spinner { border: 4px solid #e2e8f0; border-top: 4px solid #004481; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    /* Estilos para las estrellas */
    .star-rating button { color: #d1d5db; transition: color 0.2s; }
    .star-rating button:hover, .star-rating button.active { color: #fbbf24; }
  </style>

  <script>
    window.showPage = function(pageId) {
      ['page-login', 'page-home', 'page-upload', 'page-subject'].forEach(page => {
        const el = document.getElementById(page);
        if (el) el.classList.toggle('hidden', page !== pageId);
      });
      window.scrollTo(0, 0);
    };
  </script>
</head>
<body class="text-slate-800">

  <!-- MODALES -->
  <div id="loading-modal" class="modal-overlay">
    <div class="bg-white p-6 rounded-2xl shadow-2xl text-center max-w-sm w-full mx-4">
      <div class="spinner mb-4"></div>
      <p id="loading-message" class="text-slate-600 font-medium">Procesando...</p>
    </div>
  </div>
  
  <div id="message-modal" class="modal-overlay">
    <div class="bg-white p-8 rounded-2xl shadow-2xl text-center max-w-md w-full mx-4">
      <h3 id="message-title" class="text-xl font-bold mb-2 text-slate-900"></h3>
      <p id="message-body" class="mb-6 text-slate-600"></p>
      <button id="message-close-btn" class="bg-brand text-white px-6 py-2 rounded-lg hover:bg-brand-dark transition w-full font-medium">Entendido</button>
    </div>
  </div>

  <div class="container mx-auto max-w-6xl p-4 min-h-screen flex flex-col">
    
    <!-- VISTA LOGIN -->
    <div id="page-login" class="flex flex-col items-center justify-center min-h-[80vh]">
      <div class="bg-white p-10 rounded-3xl shadow-2xl text-center max-w-md w-full border border-slate-100">
        <div class="mb-6 bg-blue-50 w-20 h-20 rounded-full flex items-center justify-center mx-auto text-4xl">ğŸ“</div>
        <h1 class="text-3xl font-extrabold text-brand mb-2">Punto Aprobados</h1>
        <p class="text-slate-500 mb-8">Repositorio exclusivo para estudiantes de IngenierÃ­a Civil Industrial PUCV.</p>
        
        <div class="space-y-4">
          <button id="btn-login-google" class="w-full flex items-center justify-center gap-3 bg-white border-2 border-slate-200 text-slate-700 py-3 rounded-xl font-bold hover:bg-slate-50 hover:border-brand transition-all shadow-sm">
            <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-6 h-6" alt="Google">
            Ingresar con correo PUCV
          </button>
          <p class="text-xs text-slate-400 mt-4">Solo se permite acceso a cuentas @mail.pucv.cl</p>
        </div>
      </div>
    </div>

    <!-- INTERFAZ PRINCIPAL -->
    <div id="main-interface" class="hidden flex-grow flex flex-col">
      
      <!-- HEADER -->
      <header class="bg-white shadow-sm rounded-2xl p-6 mb-8 border-t-4 border-brand flex flex-col md:flex-row justify-between items-center gap-6">
        <div class="text-center md:text-left">
          <h1 class="text-3xl font-extrabold text-brand tracking-tight">Punto Aprobados</h1>
          <p id="user-welcome" class="text-slate-500 text-sm font-medium">Bienvenido estudiante</p>
        </div>
        <nav class="flex gap-3">
          <button onclick="window.showPage('page-home')" class="px-5 py-2.5 rounded-xl font-semibold text-brand bg-blue-50 hover:bg-blue-100 transition">ğŸ“š Biblioteca</button>
          <button onclick="window.showPage('page-upload')" class="px-5 py-2.5 rounded-xl font-semibold text-white bg-brand hover:bg-brand-dark shadow-md transition flex items-center gap-2"><span>ğŸ“¤</span> Subir</button>
          <button id="btn-logout" class="px-4 py-2.5 rounded-xl font-semibold text-slate-500 hover:text-red-500 hover:bg-red-50 transition border border-transparent hover:border-red-100">Salir</button>
        </nav>
      </header>

      <main class="flex-grow">
        <!-- HOME -->
        <div id="page-home">
          <div class="bg-gradient-to-r from-brand to-blue-600 rounded-3xl p-8 mb-8 text-white shadow-lg">
            <h2 class="text-2xl font-bold mb-2">Encuentra tu material</h2>
            <input type="text" id="search-bar" placeholder="ğŸ” Escribe aquÃ­ (ej: CÃ¡lculo, Wilson)..." class="w-full p-4 rounded-xl text-slate-800 focus:ring-4 focus:ring-blue-300 outline-none shadow-inner mt-4">
          </div>
          <div id="subjects-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5"></div>
        </div>

        <!-- SUBIR MATERIAL -->
        <div id="page-upload" class="hidden">
          <button onclick="window.showPage('page-home')" class="mb-4 text-slate-500 hover:text-brand font-medium flex items-center gap-1">â† Volver</button>
          <div class="bg-white p-8 rounded-3xl shadow-xl max-w-2xl mx-auto border border-slate-100">
            <h2 class="text-2xl font-bold text-slate-800 mb-6">Subir Aporte</h2>
            <form id="upload-form" class="space-y-5">
              <div>
                <label class="block text-sm font-bold text-slate-700 mb-1">Asignatura</label>
                <input list="subjects-options" name="subject" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:border-brand outline-none" placeholder="Selecciona o escribe..." required>
                <datalist id="subjects-options">
                  <option value="Ãlgebra Lineal"><option value="FÃ­sica MecÃ¡nica 1"><option value="Fundamentos de MatemÃ¡ticas"><option value="IntroducciÃ³n al Modelamiento Discreto"><option value="Fundamentos de IngenierÃ­a Industrial"><option value="Fundamentos de QuÃ­mica"><option value="Mundo ContemporÃ¡neo"><option value="CÃ¡lculo 1"><option value="IntroducciÃ³n a las TecnologÃ­as de la InformaciÃ³n"><option value="Taller de Creatividad e InnovaciÃ³n"><option value="FÃ­sica MecÃ¡nica 2"><option value="CÃ¡lculo 2"><option value="Arquitectura de Sistemas de Software"><option value="TermodinÃ¡mica"><option value="FÃ­sica Electromagnetismo"><option value="CÃ¡lculo 3"><option value="Operaciones Unitarias"><option value="Ecuaciones Diferenciales"><option value="Electrotecnia"><option value="AnÃ¡lisis EconÃ³mico 1"><option value="Fundamentos de Modelos ProbabilÃ­sticos"><option value="Inferencia EstadÃ­stica"><option value="Taller de ComunicaciÃ³n y NegociaciÃ³n"><option value="OptimizaciÃ³n Lineal"><option value="ElectrÃ³nica Industrial"><option value="AnÃ¡lisis EconÃ³mico 2"><option value="TeorÃ­a de Sistemas"><option value="TeorÃ­a de la OrganizaciÃ³n"><option value="Taller de Sistemas Productivos"><option value="InvestigaciÃ³n de Operaciones"><option value="GestiÃ³n Contable y Presupuestaria"><option value="GestiÃ³n de InformaciÃ³n"><option value="Ã‰tica en IngenierÃ­a"><option value="GestiÃ³n Comercial"><option value="EvaluaciÃ³n de Proyectos"><option value="SimulaciÃ³n"><option value="Taller de Liderazgo y Trabajo en Equipo"><option value="PlanificaciÃ³n de Operaciones"><option value="IngenierÃ­a Financiera"><option value="Modelamiento de Procesos y Sistemas"><option value="LogÃ­stica Integral"><option value="GestiÃ³n de Servicios"><option value="Derecho Empresarial y Ambiental"><option value="Proyecto de IngenierÃ­a Industrial"><option value="Taller de Emprendimiento">
                </datalist>
              </div>
              <div>
                <label class="block text-sm font-bold text-slate-700 mb-1">Profesor(a)</label>
                <input type="text" name="professor" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none" required>
              </div>
              <div>
                <label class="block text-sm font-bold text-slate-700 mb-1">Autor</label>
                <input type="text" name="author" id="input-author" class="w-full p-3 bg-white border border-slate-200 rounded-xl outline-none focus:border-brand transition-colors" placeholder="Ej: Tu nombre, o el del Profesor">
                <p class="text-xs text-slate-400 mt-1">Puedes editar este campo si el material no es tuyo.</p>
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-bold text-slate-700 mb-1">Tipo</label>
                  <select name="type" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none" required>
                    <option value="Apunte">ğŸ“ Apunte</option><option value="Guia">ğŸ“„ GuÃ­a</option><option value="Examen">ğŸ“ Examen</option><option value="Control">â±ï¸ Control</option><option value="Resumen">ğŸ“Œ Resumen</option><option value="Libro">ğŸ“š Libro</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-bold text-slate-700 mb-1">Archivo</label>
                  <input type="file" name="file" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:bg-blue-50 file:text-brand" required>
                </div>
              </div>
              <button type="submit" class="w-full bg-brand text-white py-3.5 rounded-xl font-bold hover:bg-brand-dark transition-all">Subir Material ğŸš€</button>
            </form>
          </div>
        </div>

        <!-- VISTA ASIGNATURA -->
        <div id="page-subject" class="hidden">
          <button onclick="window.showPage('page-home')" class="mb-6 text-slate-500 hover:text-brand font-medium flex items-center gap-1">â† Volver</button>
          <div class="bg-brand rounded-3xl p-8 mb-8 text-white shadow-lg">
            <h2 id="subject-title" class="text-3xl font-bold"></h2>
            <p class="text-blue-100 mt-1">Material disponible</p>
          </div>
          <div id="subject-files-list" class="space-y-3"></div>
        </div>
      </main>
      
      <footer class="mt-12 py-6 text-center text-slate-400 text-sm border-t border-slate-200">
        <p>Punto Aprobados Â© 2025 â€¢ IngenierÃ­a Civil Industrial PUCV</p>
      </footer>
    </div>
  </div>

  <!-- FIREBASE -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, serverTimestamp, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    // ==========================================
    // PASO 1: PEGA TUS LLAVES AQUI
    // ==========================================
       const firebaseConfig = {
  apiKey: "AIzaSyBaItXWTtatnIXt0MSnnWvq3nVAscjdPP8",
  authDomain: "punto-aprobados.firebaseapp.com",
  projectId: "punto-aprobados",
  storageBucket: "punto-aprobados.firebasestorage.app",
  messagingSenderId: "856568268041",
  appId: "1:856568268041:web:43f3b44981445157bc3fd8",
  measurementId: "G-R9359F4FNX"
}; 
    // ==========================================

    let app, auth, db, storage, currentUser;
    let allMaterials = [];

    try {
      app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getFirestore(app);
      storage = getStorage(app);
    } catch(e) { console.error("Error init:", e); }

    const loadingModal = document.getElementById('loading-modal');
    const msgModal = document.getElementById('message-modal');
    const showLoading = (msg) => { document.getElementById('loading-message').textContent = msg; loadingModal.classList.add('flex'); };
    const hideLoading = () => loadingModal.classList.remove('flex');
    const showMsg = (title, body) => {
      document.getElementById('message-title').textContent = title;
      document.getElementById('message-body').textContent = body;
      msgModal.classList.add('flex');
    };
    document.getElementById('message-close-btn').onclick = () => msgModal.classList.remove('flex');

    const provider = new GoogleAuthProvider();

    document.getElementById('btn-login-google').onclick = async () => {
      try { await signInWithPopup(auth, provider); }
      catch (error) { console.error("Error login:", error); showMsg("Error", "No se pudo iniciar sesiÃ³n. Revisa que tu correo sea PUCV."); }
    };

    document.getElementById('btn-logout').onclick = () => {
      signOut(auth);
      window.location.reload();
    };

    onAuthStateChanged(auth, (user) => {
      if (user) {
        const email = user.email || "";
        if (!email.endsWith("@mail.pucv.cl") && !email.endsWith("@pucv.cl")) {
          signOut(auth);
          showMsg("Acceso Restringido ğŸ”’", "Solo para estudiantes @mail.pucv.cl");
          return;
        }
        currentUser = user;
        document.getElementById('page-login').classList.add('hidden');
        document.getElementById('main-interface').classList.remove('hidden');
        document.getElementById('user-welcome').textContent = `Hola, ${user.displayName.split(" ")[0]}`;
        const inputAuthor = document.getElementById('input-author');
        if(!inputAuthor.value) inputAuthor.value = user.displayName;
        listenData();
      } else {
        document.getElementById('page-login').classList.remove('hidden');
        document.getElementById('main-interface').classList.add('hidden');
      }
    });

    function listenData() {
      onSnapshot(query(collection(db, "materiales_app")), (snapshot) => {
        allMaterials = [];
        snapshot.forEach(doc => allMaterials.push({id: doc.id, ...doc.data()}));
        renderHome(document.getElementById('search-bar').value);
      });
    }

    function renderHome(filter = '') {
      const list = document.getElementById('subjects-list');
      const map = new Map();
      const cleanFilter = filter.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");

      allMaterials.forEach(m => {
        const subj = m.subject || 'Otros';
        const meta = `${subj} ${m.professor} ${m.author || ''}`.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        if (filter && !meta.includes(cleanFilter)) return;
        if (!map.has(subj)) map.set(subj, { count: 0, profs: new Set() });
        const entry = map.get(subj);
        entry.count++;
        if (m.professor) entry.profs.add(m.professor);
      });

      list.innerHTML = '';
      if (map.size === 0) {
        list.innerHTML = `<div class="col-span-full text-center py-10 text-slate-400">No se encontraron resultados.</div>`;
        return;
      }

      [...map.entries()].sort().forEach(([subj, data]) => {
        const card = document.createElement('div');
        card.className = 'bg-white p-6 rounded-2xl shadow-sm border border-slate-100 cursor-pointer card-hover group';
        card.innerHTML = `
          <div class="flex justify-between items-start mb-3">
            <div class="p-3 bg-blue-50 rounded-xl text-brand text-xl">ğŸ“š</div>
            <span class="bg-slate-100 text-slate-600 text-xs font-bold px-2 py-1 rounded-lg">${data.count} Docs</span>
          </div>
          <h3 class="font-bold text-slate-800 text-lg group-hover:text-brand transition">${subj}</h3>
          <p class="text-sm text-slate-500 mt-2 truncate">Prof: ${[...data.profs].join(', ') || 'Varios'}</p>
        `;
        card.onclick = () => showSubjectPage(subj);
        list.appendChild(card);
      });
    }

    function showSubjectPage(subj) {
      window.showPage('page-subject');
      document.getElementById('subject-title').textContent = subj;
      const list = document.getElementById('subject-files-list');
      list.innerHTML = '';

      const files = allMaterials.filter(m => m.subject === subj);
      files.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
      
      files.forEach(f => {
        const row = document.createElement('div');
        row.className = 'bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4';
        
        let icon = 'ğŸ“„';
        if(f.type === 'Examen') icon = 'ğŸ“'; if(f.type === 'Control') icon = 'â±ï¸';

        // LÃ³gica de Ratings
        const ratingsMap = f.ratings || {}; 
        const ratingValues = Object.values(ratingsMap);
        const ratingCount = ratingValues.length;
        const average = ratingCount > 0 ? (ratingValues.reduce((a, b) => a + b, 0) / ratingCount).toFixed(1) : 0;
        
        // Generar estrellas HTML
        let starsHtml = '';
        for(let i=1; i<=5; i++) {
          const activeClass = i <= Math.round(average) ? 'text-yellow-400' : 'text-gray-300';
          // Usamos una funciÃ³n global temporal para el onclick
          starsHtml += `<button onclick="window.rateMaterial('${f.id}', ${i})" class="text-xl ${activeClass} hover:scale-125 transition">â˜…</button>`;
        }

        row.innerHTML = `
          <div class="flex-grow w-full md:w-auto">
            <div class="flex items-center gap-3">
              <span class="text-2xl">${icon}</span>
              <div>
                <h4 class="font-bold text-slate-800">${f.fileName}</h4>
                <div class="flex flex-wrap gap-3 text-xs text-slate-500 mt-1">
                  <span class="bg-slate-100 px-2 py-0.5 rounded">ğŸ·ï¸ ${f.type}</span>
                  <span>ğŸ‘¨â€ğŸ« ${f.professor}</span>
                  <span class="text-brand font-medium">ğŸ‘¤ ${f.author || 'AnÃ³nimo'}</span>
                </div>
              </div>
            </div>
          </div>
          
          <div class="flex flex-col items-end gap-2">
            <div class="flex items-center gap-1">
              <span class="text-sm font-bold text-slate-700 mr-2">${average > 0 ? average : '-'}</span>
              <div class="star-rating flex">${starsHtml}</div>
              <span class="text-xs text-slate-400">(${ratingCount})</span>
            </div>
            <a href="${f.downloadURL}" target="_blank" class="w-full md:w-auto text-center bg-white border-2 border-brand text-brand hover:bg-brand hover:text-white px-6 py-1.5 rounded-lg font-bold transition text-sm">Descargar</a>
          </div>
        `;
        list.appendChild(row);
      });
    }

    // FunciÃ³n global para calificar
    window.rateMaterial = async (docId, rating) => {
      if(!currentUser) return showMsg("Error", "Debes iniciar sesiÃ³n");
      try {
        const docRef = doc(db, "materiales_app", docId);
        // Usamos notaciÃ³n de punto para actualizar una llave especÃ­fica del mapa
        const updateObj = {};
        updateObj[`ratings.${currentUser.uid}`] = rating;
        await updateDoc(docRef, updateObj);
        // No necesitamos recargar, el listener lo harÃ¡
      } catch (e) {
        console.error("Error rating:", e);
        showMsg("Error", "No se pudo guardar tu calificaciÃ³n.");
      }
    };

    async function handleUpload(e) {
      e.preventDefault();
      const f = e.target;
      const file = f.file.files[0];
      if (!file) return showMsg("Error", "Falta el archivo");

      showLoading("Subiendo...");
      try {
        const finalAuthorName = f.author.value.trim() || currentUser.displayName || 'AnÃ³nimo';
        const docRef = await addDoc(collection(db, "materiales_app"), {
          subject: f.subject.value.trim(),
          professor: f.professor.value.trim(),
          author: finalAuthorName,
          type: f.type.value,
          fileName: file.name,
          uploadedBy: currentUser.uid,
          uploadedByEmail: currentUser.email,
          createdAt: serverTimestamp(),
          downloadURL: '',
          ratings: {} // Inicializamos mapa de ratings vacÃ­o
        });

        const upTask = uploadBytesResumable(ref(storage, `materiales_app/${docRef.id}/${file.name}`), file);
        
        upTask.on('state_changed', null, 
          (err) => { console.error(err); hideLoading(); showMsg("Error", "FallÃ³ la subida"); },
          async () => {
            const url = await getDownloadURL(upTask.snapshot.ref);
            await updateDoc(docRef, { downloadURL: url });
            hideLoading();
            showMsg("Â¡Ã‰xito!", "Material publicado correctamente.");
            f.reset();
            document.getElementById('input-author').value = currentUser.displayName;
            window.showPage('page-home');
          }
        );
      } catch (err) { console.error(err); hideLoading(); showMsg("Error", "OcurriÃ³ un error."); }
    }

    document.getElementById('upload-form').onsubmit = handleUpload;
    document.getElementById('search-bar').onkeyup = (e) => renderHome(e.target.value);
  </script>
</body>
</html>
